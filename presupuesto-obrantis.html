<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OBRANTIS S.L. — Presupuesto interactivo</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a33;
      --text:#e9eefc;
      --muted:#b8c3e6;
      --line:rgba(255,255,255,.12);
      --accent:#6aa6ff;
      --ok:#39d98a;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(106,166,255,.18), transparent 60%),
        radial-gradient(1200px 600px at 90% 10%, rgba(57,217,138,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1120px;margin:28px auto;padding:0 18px}
    .topbar{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      margin-bottom:16px;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px;height:46px;border-radius:14px;
      background: linear-gradient(135deg, rgba(106,166,255,.9), rgba(57,217,138,.85));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:13px}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    button{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.2)}
    button:active{transform: translateY(1px)}
    .btn-accent{
      background: linear-gradient(135deg, rgba(106,166,255,.95), rgba(106,166,255,.55));
      border-color: rgba(106,166,255,.65);
    }
    .btn-ok{
      background: linear-gradient(135deg, rgba(57,217,138,.95), rgba(57,217,138,.55));
      border-color: rgba(57,217,138,.65);
    }
    .btn-warn{
      background: linear-gradient(135deg, rgba(255,204,102,.95), rgba(255,204,102,.5));
      border-color: rgba(255,204,102,.65);
      color:#152033;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .actions{justify-content:flex-start} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .card .hd h2{margin:0;font-size:14px;letter-spacing:.2px;color: var(--text);}
    .card .bd{padding:14px 16px}
    .muted{color:var(--muted); font-size:13px; line-height:1.35}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px}
    @media (max-width: 620px){ .row{grid-template-columns:1fr} }

    label{display:block; font-size:12px; color: var(--muted); margin-bottom:6px}
    input, textarea, select{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    input[type="number"]{font-family:var(--mono)}
    .mini{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .pill{
      border:1px solid rgba(255,255,255,.14);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color: var(--muted);
      background: rgba(0,0,0,.18);
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.10); vertical-align:top;}
    th{text-align:left; font-size:12px; color: var(--muted); background: rgba(255,255,255,.04);}
    tr:last-child td{border-bottom:none}
    td input, td textarea{border-radius:10px; padding:8px 8px; background: rgba(0,0,0,.16);}
    td textarea{min-height:44px}
    .td-actions{white-space:nowrap; width:1%}
    .iconbtn{padding:8px 10px; border-radius:12px; font-family: var(--mono); font-weight:700;}

    .summary{display:grid; gap:10px;}
    .sumline{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .sumline strong{font-family:var(--mono)}
    .sumtotal{
      background: linear-gradient(135deg, rgba(106,166,255,.18), rgba(57,217,138,.12));
      border-color: rgba(106,166,255,.25);
    }

    .note{
      border-left: 4px solid rgba(255,204,102,.8);
      background: rgba(255,204,102,.08);
      padding:10px 12px;
      border-radius: 12px;
      font-size:13px;
      color: var(--text);
    }
    .danger{
      border-left: 4px solid rgba(255,107,107,.85);
      background: rgba(255,107,107,.08);
      padding:10px 12px;
      border-radius: 12px;
      font-size:13px;
    }

    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }

    .footer{margin-top:16px;color: var(--muted);font-size:12px;text-align:center;opacity:.9;}

    #printArea{padding:0;background:transparent;}

    .modal{
      position:fixed; inset:0; display:none;
      background: rgba(0,0,0,.55);
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal.open{display:flex}
    .modal .box{
      width:min(780px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(15,26,51,.98), rgba(11,18,32,.98));
      box-shadow: 0 24px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modal .box .hd{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .modal .box .bd{padding:14px 16px}
    .modal pre{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      padding:12px;
      border-radius: 14px;
      overflow:auto;
      color: var(--text);
      font-family: var(--mono);
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
    }

    /* Impresión básica */
    @media print{
      body{background:#fff;color:#000}
      .actions, .footer, .modal{display:none !important}
      .card{box-shadow:none}
    }
    /* ===== ESTILOS SOLO PARA PDF / IMPRESIÓN ===== */
@media print {

  body {
    background: #ffffff !important;
    color: #000000 !important;
  }

  .card,
  .sumline,
  .note,
  .danger {
    background: #ffffff !important;
    border: 1px solid #cccccc !important;
    box-shadow: none !important;
  }

  h1, h2, h3, h4 {
    color: #000000 !important;
  }

  label,
  .muted,
  .pill {
    color: #333333 !important;
  }

  input,
  textarea,
  select {
    background: #ffffff !important;
    color: #000000 !important;
    border: 1px solid #999999 !important;
  }

  table {
    background: #ffffff !important;
  }

  th {
    background: #f0f0f0 !important;
    color: #000000 !important;
  }

  td {
    color: #000000 !important;
  }

  .sumtotal {
    background: #e6f0ff !important;
    border: 2px solid #000000 !important;
    font-weight: bold;
  }

  .actions,
  button {
    display: none !important;
  }
}
/* ===== MODO PDF FORZADO (html2pdf) ===== */
body.pdf-mode {
  background: #ffffff !important;
  color: #000000 !important;
}

body.pdf-mode * {
  color: #000000 !important;
}

body.pdf-mode .card,
body.pdf-mode .sumline,
body.pdf-mode .note,
body.pdf-mode .danger {
  background: #ffffff !important;
  border: 1px solid #000000 !important;
  box-shadow: none !important;
}

body.pdf-mode input,
body.pdf-mode textarea,
body.pdf-mode select {
  background: #ffffff !important;
  color: #000000 !important;
  border: 1px solid #000000 !important;
}

body.pdf-mode th {
  background: #f0f0f0 !important;
  color: #000000 !important;
}

body.pdf-mode td {
  color: #000000 !important;
}

body.pdf-mode .sumtotal {
  background: #e6f0ff !important;
  border: 2px solid #000000 !important;
  font-weight: bold;
}

body.pdf-mode .actions,
body.pdf-mode button {
  display: none !important;
}
/* =====================
   AJUSTES PARA PDF
   ===================== */
@media print {

  body {
    background: #ffffff !important;
  }

  /* Evitar cortes internos */
  .card,
  .grid,
  .row,
  .bd,
  .hd,
  table,
  tr,
  .sumtotal {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
  }

  /* Separar bloques grandes correctamente */
  .card {
    page-break-after: auto;
  }

  /* Ocultar botones en PDF */
  .actions,
  button {
    display: none !important;
  }
}
/* ===== LOGO REAL ===== */
.logo-img{
  width: 56px;
  height: 56px;
  object-fit: contain;
  border-radius: 12px;
  background: transparent;
  display: block;
}

/* En PDF, un poco más compacto */
@media print{
  .logo-img{
    width: 48px !important;
    height: 48px !important;
  }
}
/* ===== CABECERA ===== */
.header{
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 18px;
}

.header h1{
  margin: 0;
  font-size: 22px;
  line-height: 1.2;
  font-weight: 700;
}

.header p{
  margin: 4px 0 0 0;
  font-size: 13px;
  line-height: 1.25;
  font-weight: 400;
  color: #555;
  letter-spacing: 0.2px;
}
/* ===============================
   MEJORA DE LEGIBILIDAD DE TEXTOS
   =============================== */

/* Textos generales */
body {
  line-height: 1.45;
}

/* Párrafos */
p {
  line-height: 1.5;
  margin: 6px 0 10px 0;
}

/* Cajas de texto grandes (incluye / no incluye / observaciones) */
.box,
.textbox,
textarea,
.note,
.summary-box {
  line-height: 1.55;
  padding: 12px 14px;
  word-break: break-word;
  white-space: normal;
}

/* Textos largos dentro de cajas */
.box p,
.textbox p {
  margin-bottom: 8px;
}

/* Pie de página */
.footer,
footer {
  margin-top: 20px;
  line-height: 1.4;
}

/* Evitar textos pegados en PDF */
@media print {
  body {
    line-height: 1.5;
  }

  p {
    margin-bottom: 10px;
  }
}
/* ===== FIX ESPACIADO TEXTO EN PDF/HTML2CANVAS ===== */
.subtitle{
  letter-spacing: 0 !important;
  word-spacing: 0.10em !important;
  white-space: normal !important;
  line-height: 1.25 !important;
}

/* Asegurar que html2canvas no aplaste el texto */
body.pdf-mode .subtitle{
  letter-spacing: 0 !important;
  word-spacing: 0.12em !important;
}

  </style>
</head>

<body>
  <div class="wrap" id="printArea">
    <div class="topbar">
      <div class="brand">
        <img class="logo-img" src="logo obrantis BLANCO.png" alt="OBRANTIS" />

        <div>
          <h1>OBRANTIS S.L. — Presupuesto</h1>
          <p class="subtitle">Reformas generales y electricidad · IVA 21% · Partidas editables y aceptación</p>

        </div>
      </div>
      <div class="actions">
        <button class="btn-warn" id="btnReset" type="button">Restablecer</button>
        <button class="btn-accent" id="btnPDF" type="button">Descargar PDF</button>
        <button class="btn-ok" id="btnAccept" type="button">Aceptar presupuesto</button>
      </div>
    </div>

    <div class="grid">
      <div class="card no-break">
        <div class="hd">
          <h2>1) Datos generales</h2>
          <div class="mini">
            <span class="pill" id="pillNumber">Nº: OBR-2026-001</span>
            <span class="pill" id="pillDate"></span>
          </div>
        </div>
        <div class="bd">

          <div class="row">
            <div>
              <label>Empresa / Profesional</label>
              <input id="proName" value="OBRANTIS S.L. (empresa en constitución)" />
            </div>
            <div>
              <label>Contacto</label>
              <input id="proContact" value="Tel.: 610 673 307 | administracion@obrantis.com" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Cliente</label>
              <input id="clientName" placeholder="Nombre y apellidos / empresa" />
            </div>
            <div>
              <label>Dirección de la obra</label>
              <input id="siteAddress" placeholder="Calle, número, localidad" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Tipo de trabajo</label>
              <select id="workType">
                <option value="reforma" selected>Reforma general</option>
                <option value="electricidad">Electricidad</option>
                <option value="mixto">Reforma + Electricidad (mixto)</option>
                <option value="averia">Avería eléctrica / diagnóstico</option>
              </select>
            </div>
            <div>
              <label>Validez del presupuesto</label>
              <select id="validity">
                <option value="15">15 días</option>
                <option value="30" selected>30 días</option>
                <option value="45">45 días</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Resumen del encargo (visible para el cliente)</label>
              <textarea id="jobSummary" placeholder="Ej.: Reforma integral de baño/cocina, con sustitución de instalaciones, revestimientos y acabados."></textarea>
            </div>
            <div>
              <label>Análisis técnico inicial (qué implica)</label>
              <textarea id="techAnalysis" placeholder="Ej.: Replanteo, protecciones, demoliciones, instalaciones, alicatado/solado, montaje y remates."></textarea>
            </div>
          </div>

        </div>
      </div>

      <div class="card no-break">
        <div class="hd">
          <h2>2) Resumen económico</h2>
          <div class="mini">
            <span class="pill">IVA por defecto: 21%</span>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="grid-template-columns:1fr 1fr">
            <div>
              <label>IVA</label>
              <select id="vatRate">
                <option value="21" selected>21%</option>
                <option value="10">10%</option>
                <option value="0">0%</option>
              </select>
            </div>
            <div>
              <label>Descuento global (€)</label>
              <input id="globalDiscount" type="number" min="0" step="0.01" value="0" />
            </div>
          </div>

          <div class="summary">
            <div class="sumline"><span>Base imponible</span><strong id="subTotal">0,00 €</strong></div>
            <div class="sumline"><span>Descuento total</span><strong id="discTotal">0,00 €</strong></div>
            <div class="sumline"><span>IVA</span><strong id="vatTotal">0,00 €</strong></div>
            <div class="sumline sumtotal"><span>Total</span><strong id="grandTotal">0,00 €</strong></div>
          </div>

          <div style="height:10px"></div>

          <div class="note">
            Presupuesto sujeto a confirmación de mediciones, accesos y condiciones de obra. Cualquier modificación de alcance se presupuestará aparte antes de ejecutar.
          </div>

          <div style="height:10px"></div>

          <div class="danger" id="safetyBox" style="display:none">
            Aviso de seguridad: si hay olor a quemado, chispazos, calentamiento anormal o saltos repetidos del automático, se recomienda cortar suministro y realizar revisión urgente.
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="hd">
          <h2>3) Partidas del presupuesto</h2>
          <div class="mini">
            <button class="iconbtn" id="btnAddRow" type="button">+ Añadir partida</button>
          </div>
        </div>
        <div class="bd">
          <div class="muted" style="margin-bottom:10px">
            Puedes usar el mismo documento para reforma o electricidad. Edita partidas, cantidades y precios; el total se recalcula automáticamente.
          </div>

          <table aria-label="Partidas">
            <thead>
              <tr>
                <th style="width:38%">Descripción</th>
                <th style="width:12%">Ud.</th>
                <th style="width:12%">Cantidad</th>
                <th style="width:14%">Precio</th>
                <th style="width:12%">Dto. %</th>
                <th style="width:12%">Importe</th>
                <th class="td-actions">Acción</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>

          <div class="split" style="margin-top:12px">
            <div>
              <label>Qué incluye el precio</label>
              <textarea id="includes">
- Mano de obra y gestión de ejecución según alcance descrito.
- Materiales y suministros según partidas (salvo que se indique lo contrario).
- Protección de zonas de paso y limpieza básica diaria.
- Retirada de escombro/RSU en sacos o pequeño volumen (si aplica y se detalla).
- Pruebas de funcionamiento / verificación básica de instalaciones ejecutadas.
              </textarea>
            </div>
            <div>
              <label>Qué NO incluye (exclusiones)</label>
              <textarea id="excludes">
- Licencias municipales, tasas, proyectos técnicos visados o dirección facultativa (si fueran necesarios y no se detallan).
- Actuaciones no descritas expresamente en partidas (trabajos extra).
- Reparación de vicios ocultos o daños preexistentes no visibles hasta abrir.
- Pintura integral si no se presupuesta; mobiliario/electrodomésticos; elementos decorativos.
- Aumento de potencia, trámites con comercializadora/distribuidora, y boletines/CIE si no se incluye partida específica.
              </textarea>
            </div>
          </div>

          <div class="split" style="margin-top:12px">
            <div>
              <label>Condiciones de pago y plazos</label>
              <textarea id="terms">
- Reserva y planificación: 40% a la aceptación para acopio de material y agenda.
- Pagos intermedios: según hitos/avance (si procede).
- Resto: a finalización y entrega, tras comprobación del cliente.
- Plazo estimado: según alcance y disponibilidad (se fijará tras replanteo/visita si procede).
- Validez: la indicada en este documento.
              </textarea>
            </div>
            <div>
              <label>Próximos pasos</label>
              <textarea id="nextSteps">
1) Enviar aceptación por escrito (WhatsApp o email).
2) Visita de replanteo/medición si procede.
3) Confirmación de alcance final, materiales y fechas.
4) Ejecución y cierre con comprobaciones y entrega.
              </textarea>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>Observaciones</label>
              <textarea id="notes" placeholder="Ej.: horarios permitidos, accesos, ascensor, retirada de escombro, permisos de comunidad, etc."></textarea>
            </div>
            <div>
              <label>Garantía / condiciones especiales</label>
              <textarea id="warranty">
- Garantía de mano de obra: 6 meses (salvo manipulación por terceros o mal uso).
- Garantía de materiales: según fabricante.
- Cualquier modificación del alcance o mediciones se comunicará y presupuestará antes de ejecutar.
              </textarea>
            </div>
          </div>

        </div>
      </div>

    </div>

    <div class="footer">
      OBRANTIS S.L. — Documento de propuesta económica para cliente. Puedes personalizar número, textos y partidas.
    </div>
  </div>

  <div class="modal" id="acceptModal" role="dialog" aria-modal="true" aria-labelledby="acceptTitle">
    <div class="box">
      <div class="hd">
        <h2 id="acceptTitle" style="margin:0;font-size:14px;">Aceptación del presupuesto</h2>
        <button type="button" id="btnCloseModal">Cerrar</button>
      </div>
      <div class="bd">
        <div class="muted" style="margin-bottom:10px">
          Copia y pega este texto para firma (WhatsApp, email o documento).
        </div>
        <pre id="acceptText"></pre>
        <div class="mini" style="margin-top:10px">
          <button type="button" class="btn-accent" id="btnCopyAccept">Copiar texto</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <script>
    const eur = (n) => {
      const v = Number(n || 0);
      return v.toLocaleString('es-ES', { style:'currency', currency:'EUR' });
    };
    const num = (v) => {
      const x = String(v ?? '').replace(',', '.');
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    };

    const today = new Date();
    const dateStr = today.toLocaleDateString('es-ES', { year:'numeric', month:'2-digit', day:'2-digit' });
    document.getElementById('pillDate').textContent = "Fecha: " + dateStr;

    // Plantillas de partidas por tipo de trabajo
    const templates = {
      reforma: [
        { desc: "Visita técnica, medición y replanteo", unit:"serv", qty:1, price:60, disc:0 },
        { desc: "Protecciones, desmontajes y demoliciones (según alcance)", unit:"lote", qty:1, price:350, disc:0 },
        { desc: "Gestión y ejecución de albañilería / rozas / remates", unit:"lote", qty:1, price:520, disc:0 },
        { desc: "Materiales y consumibles (según partidas y calidades)", unit:"lote", qty:1, price:480, disc:0 }
      ],
      electricidad: [
        { desc: "Visita técnica y replanteo", unit:"serv", qty:1, price:45, disc:0 },
        { desc: "Mano de obra instalación / montaje", unit:"h", qty:8, price:35, disc:0 },
        { desc: "Material eléctrico (según partidas)", unit:"lote", qty:1, price:220, disc:0 },
        { desc: "Pruebas y verificación básica", unit:"serv", qty:1, price:35, disc:0 }
      ],
      mixto: [
        { desc: "Visita técnica, medición y replanteo", unit:"serv", qty:1, price:75, disc:0 },
        { desc: "Demoliciones y preparación de soportes", unit:"lote", qty:1, price:420, disc:0 },
        { desc: "Instalación eléctrica (líneas/mecanismos/cuadro según alcance)", unit:"lote", qty:1, price:650, disc:0 },
        { desc: "Materiales (obra + eléctrico) según partidas", unit:"lote", qty:1, price:650, disc:0 }
      ],
      averia: [
        { desc: "Desplazamiento + diagnóstico (sin reparación)", unit:"serv", qty:1, price:65, disc:0 },
        { desc: "Mano de obra reparación (si procede)", unit:"h", qty:1, price:45, disc:0 },
        { desc: "Material eléctrico (si procede)", unit:"lote", qty:1, price:35, disc:0 }
      ]
    };

    const itemsBody = document.getElementById('itemsBody');

    function rowTemplate(item){
      const tr = document.createElement('tr');

      const tdDesc = document.createElement('td');
      const ta = document.createElement('textarea');
      ta.value = item.desc || "";
      ta.addEventListener('input', recalc);
      tdDesc.appendChild(ta);

      const tdUnit = document.createElement('td');
      const inpUnit = document.createElement('input');
      inpUnit.value = item.unit || "ud";
      inpUnit.addEventListener('input', recalc);
      tdUnit.appendChild(inpUnit);

      const tdQty = document.createElement('td');
      const inpQty = document.createElement('input');
      inpQty.type = 'number';
      inpQty.min = '0';
      inpQty.step = '0.01';
      inpQty.value = item.qty ?? 1;
      inpQty.addEventListener('input', recalc);
      tdQty.appendChild(inpQty);

      const tdPrice = document.createElement('td');
      const inpPrice = document.createElement('input');
      inpPrice.type = 'number';
      inpPrice.min = '0';
      inpPrice.step = '0.01';
      inpPrice.value = item.price ?? 0;
      inpPrice.addEventListener('input', recalc);
      tdPrice.appendChild(inpPrice);

      const tdDisc = document.createElement('td');
      const inpDisc = document.createElement('input');
      inpDisc.type = 'number';
      inpDisc.min = '0';
      inpDisc.step = '0.01';
      inpDisc.value = item.disc ?? 0;
      inpDisc.addEventListener('input', recalc);
      tdDisc.appendChild(inpDisc);

      const tdAmt = document.createElement('td');
      const amt = document.createElement('div');
      amt.style.fontFamily = 'var(--mono)';
      amt.textContent = eur(0);
      tdAmt.appendChild(amt);

      const tdAct = document.createElement('td');
      tdAct.className = "td-actions";
      const btnDel = document.createElement('button');
      btnDel.type = 'button';
      btnDel.className = "iconbtn";
      btnDel.textContent = "—";
      btnDel.title = "Eliminar partida";
      btnDel.addEventListener('click', () => {
        tr.remove();
        recalc();
      });
      tdAct.appendChild(btnDel);

      tr.appendChild(tdDesc);
      tr.appendChild(tdUnit);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdDisc);
      tr.appendChild(tdAmt);
      tr.appendChild(tdAct);

      tr._refs = { ta, inpUnit, inpQty, inpPrice, inpDisc, amt };
      return tr;
    }

    function addRow(item){
      const tr = rowTemplate(item || {desc:"", unit:"ud", qty:1, price:0, disc:0});
      itemsBody.appendChild(tr);
      recalc();
    }

    function setRowsFromTemplate(type){
      itemsBody.innerHTML = "";
      (templates[type] || templates.reforma).forEach(addRow);
      recalc();
    }

    function recalc(){
      let subtotal = 0;
      let lineDiscountTotal = 0;

      [...itemsBody.querySelectorAll('tr')].forEach(tr => {
        const { inpQty, inpPrice, inpDisc, amt } = tr._refs;
        const qty = num(inpQty.value);
        const price = num(inpPrice.value);
        const disc = Math.max(0, Math.min(100, num(inpDisc.value)));

        const line = qty * price;
        const lineDisc = line * (disc/100);
        const lineNet = line - lineDisc;

        subtotal += lineNet;
        lineDiscountTotal += lineDisc;

        amt.textContent = eur(lineNet);
      });

      const globalDisc = Math.max(0, num(document.getElementById('globalDiscount').value));
      const vatRate = num(document.getElementById('vatRate').value);

      const base = Math.max(0, subtotal - globalDisc);
      const vat = base * (vatRate/100);
      const total = base + vat;

      document.getElementById('subTotal').textContent = eur(subtotal);
      document.getElementById('discTotal').textContent = eur(lineDiscountTotal + globalDisc);
      document.getElementById('vatTotal').textContent = eur(vat);
      document.getElementById('grandTotal').textContent = eur(total);

      const type = document.getElementById('workType').value;
      document.getElementById('safetyBox').style.display = (type === 'averia') ? 'block' : 'none';
    }

    // Inicializar con plantilla reforma y IVA 21% por defecto
    setRowsFromTemplate('reforma');
    document.getElementById('vatRate').value = "21";
    recalc();

    // Eventos
    document.getElementById('vatRate').addEventListener('change', recalc);
    document.getElementById('globalDiscount').addEventListener('input', recalc);

    document.getElementById('workType').addEventListener('change', (e) => {
      const type = e.target.value;
      setRowsFromTemplate(type);
    });

    document.getElementById('btnAddRow').addEventListener('click', () => addRow());

    document.getElementById('btnReset').addEventListener('click', () => {
      if(!confirm('¿Restablecer los datos y volver a valores de ejemplo?')) return;
      document.getElementById('clientName').value = "";
      document.getElementById('siteAddress').value = "";
      document.getElementById('jobSummary').value = "";
      document.getElementById('techAnalysis').value = "";
      document.getElementById('notes').value = "";
      document.getElementById('vatRate').value = "21";
      document.getElementById('globalDiscount').value = "0";
      document.getElementById('workType').value = "reforma";
      setRowsFromTemplate('reforma');
      recalc();
    });

    // PDF (usa html2pdf por CDN)
   document.getElementById('btnPDF').addEventListener('click', () => {
  recalc();

  // Activar modo PDF (contraste alto / fondo blanco)
  document.body.classList.add('pdf-mode');

  const element = document.getElementById('printArea');
  const number = document.getElementById('pillNumber')
    ? document.getElementById('pillNumber').textContent.replace('Nº:','').trim()
    : 'presupuesto-obrantis';

  const opt = {
  margin: [12, 10, 12, 10],
  filename: number + '.pdf',
  image: { type: 'jpeg', quality: 0.98 },
  html2canvas: {
    scale: 2,
    useCORS: true,
    backgroundColor: '#ffffff'
  },
  jsPDF: {
    unit: 'mm',
    format: 'a4',
    orientation: 'portrait'
  },
  pagebreak: {
    mode: ['css', 'legacy'],
    avoid: ['.card', '.no-break']
  }
};



  setTimeout(() => {
    html2pdf().set(opt).from(element).save().then(() => {
      document.body.classList.remove('pdf-mode');
    }).catch(() => {
      document.body.classList.remove('pdf-mode');
    });
  }, 150);
});


    // Aceptación
    const modal = document.getElementById('acceptModal');
    const acceptText = document.getElementById('acceptText');

    function buildAcceptance(){
      recalc();
      const pro = document.getElementById('proName').value.trim() || "OBRANTIS S.L.";
      const proContact = document.getElementById('proContact').value.trim();
      const client = document.getElementById('clientName').value.trim() || "[Cliente]";
      const address = document.getElementById('siteAddress').value.trim() || "[Dirección de obra]";
      const number = document.getElementById('pillNumber').textContent.replace('Nº: ','').trim();
      const validity = document.getElementById('validity').value;
      const total = document.getElementById('grandTotal').textContent;

      const summary = document.getElementById('jobSummary').value.trim() || "[Resumen del encargo]";
      const terms = document.getElementById('terms').value.trim();
      const includes = document.getElementById('includes').value.trim();
      const excludes = document.getElementById('excludes').value.trim();

      const lines = [...itemsBody.querySelectorAll('tr')].map((tr, i) => {
        const r = tr._refs;
        const desc = (r.ta.value || "").trim() || "Partida";
        const unit = (r.inpUnit.value || "ud").trim();
        const qty = num(r.inpQty.value);
        const price = num(r.inpPrice.value);
        const disc = Math.max(0, Math.min(100, num(r.inpDisc.value)));
        const net = qty * price * (1 - disc/100);
        return `${String(i+1).padStart(2,'0')}. ${desc} | ${qty} ${unit} x ${eur(price)} | Dto ${disc}% | Importe: ${eur(net)}`;
      }).join('\n');

      return (
`ACEPTACIÓN DE PRESUPUESTO

Cliente: ${client}
Dirección de la obra: ${address}
Presupuesto nº: ${number}
Fecha: ${dateStr}
Validez: ${validity} días

Resumen del encargo:
${summary}

Partidas:
${lines}

Total presupuesto (IVA incluido): ${total}

Incluye:
${includes}

No incluye:
${excludes}

Condiciones de pago y plazos:
${terms}

Confirmo la aceptación del presupuesto y autorizo el inicio de los trabajos según el alcance descrito.

Firma cliente: _____________________________   DNI/NIF: ____________________
Fecha: ____ / ____ / _______

Empresa / Profesional: ${pro}
Contacto: ${proContact}
`);
    }

    document.getElementById('btnAccept').addEventListener('click', () => {
      acceptText.textContent = buildAcceptance();
      modal.classList.add('open');
    });

    document.getElementById('btnCloseModal').addEventListener('click', () => {
      modal.classList.remove('open');
    });
    modal.addEventListener('click', (e) => {
      if(e.target === modal) modal.classList.remove('open');
    });

    document.getElementById('btnCopyAccept').addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(acceptText.textContent);
        alert('Texto copiado.');
      }catch(err){
        alert('No se pudo copiar automáticamente. Selecciona el texto y copia manualmente.');
      }
    });
  </script>
</body>
</html>

