<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Presupuesto OBRANTIS</title>
  <style>
    :root{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    body{margin:0;background:#f5f7fb;color:#111;}
    header{padding:16px 18px;background:#fff;border-bottom:1px solid #e8ecf3;position:sticky;top:0;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#eef3ff;border:1px solid #dbe7ff;font-weight:700}
    .btn{border:1px solid #d8deea;background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:700}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    main{padding:18px}
    .card{background:#fff;border:1px solid #e8ecf3;border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 10px 24px rgba(0,0,0,.04)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    label{display:block;font-size:12px;font-weight:700;color:#3b465a;margin:0 0 6px}
    input,textarea,select{width:100%;box-sizing:border-box;border:1px solid #d8deea;border-radius:10px;padding:10px 12px;font:inherit;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .hint{font-size:12px;color:#5a6476}

    /* ===== PARTIDAS (estructura estándar) ===== */
    #items .item-row{display:grid;grid-template-columns: 1.2fr .5fr .4fr .2fr; gap:10px; align-items:start; padding:12px; border:1px solid #e8ecf3; border-radius:12px; margin:10px 0; background:#fbfcff}
    #items .item-row .btn{padding:10px 10px}

    /* ===== MODAL (scroll real) ===== */
    .modal-overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 9999;
    }
    .modal-overlay.open{ display:flex; }
    .modal-backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.55);
    }
    .modal-panel{
      position:relative;
      width:min(920px, 100%);
      max-height: calc(100vh - 48px);
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border-bottom:1px solid #e9e9e9;background:#fafafa;
    }
    .modal-title{margin:0;font-size:16px;font-weight:800}
    .modal-close{border:0;background:transparent;font-size:22px;cursor:pointer;padding:6px 10px}
    .modal-body{
      padding:16px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      white-space: pre-wrap;
      line-height: 1.35;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
    }
    body.modal-open{overflow:hidden;height:100%}

    @media (max-width:900px){
      .col-6{grid-column:span 12}
      #items .item-row{grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="pill" id="pillNumber">Nº: OBR-AAAA-000</div>
        <button class="btn" id="btnNewNumber" type="button">Generar número</button>
        <button class="btn primary" id="btnAccept" type="button">Aceptar presupuesto</button>
        <button class="btn" id="btnRevision" type="button" disabled>Crear revisión</button>
        <span class="hint" id="lockHint"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2 style="margin:0 0 10px">Datos del cliente</h2>
      <div class="grid">
        <div class="col-6">
          <label>Cliente</label>
          <input id="clientName" placeholder="Nombre / Empresa" />
        </div>
        <div class="col-6">
          <label>DNI/NIF</label>
          <input id="clientNif" placeholder="DNI / NIF" />
        </div>
        <div class="col-6">
          <label>Dirección de obra</label>
          <input id="workAddress" placeholder="Dirección" />
        </div>
        <div class="col-6">
          <label>Teléfono / Email</label>
          <input id="clientContact" placeholder="Teléfono / Email" />
        </div>
        <div class="col-12">
          <label>Observaciones</label>
          <textarea id="notes" placeholder="Notas internas o del cliente"></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Partidas</h2>
        <button class="btn" id="btnAddItem" type="button">Añadir partida</button>
      </div>

      <!--
        IMPORTANTE:
        Si tu HTML real de partidas es distinto, aquí es donde se adapta.
        Este sistema funciona con #items y cada fila .item-row.
      -->
      <div id="items"></div>

      <div class="hint" style="margin-top:10px">
        Consejo: el texto largo se mantiene completo. El problema que tenías era el modal sin scroll.
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px">Condiciones</h2>
      <div class="grid">
        <div class="col-12">
          <label>Condiciones de pago y plazos</label>
          <textarea id="terms" placeholder="Ej: 50% inicio, 50% fin. Plazo: 10-15 días laborables."></textarea>
        </div>
        <div class="col-12">
          <label>Datos profesionales</label>
          <textarea id="pro" placeholder="OBRANTIS, S.L. ..."></textarea>
        </div>
        <div class="col-12">
          <label>Contacto profesional</label>
          <input id="proContact" placeholder="Teléfono / Email" />
        </div>
      </div>
    </section>
  </main>

  <!-- ===== MODAL ACEPTACIÓN ===== -->
  <div id="modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Texto de aceptación</h3>
        <div class="row" style="gap:8px">
          <button class="btn" id="btnCopyAccept" type="button">Copiar</button>
          <button class="modal-close" id="btnCloseModal" type="button" aria-label="Cerrar">×</button>
        </div>
      </div>
      <div class="modal-body" id="acceptText"></div>
    </div>
  </div>

  <script>
    // ==========================
    // NUMERACIÓN AUTOMÁTICA (GLOBAL)
    // ==========================
    const BUDGET_SERIES = 'OBR';

    function yearNow(){ return new Date().getFullYear(); }
    function pad3(n){ return String(n).padStart(3,'0'); }
    function nextCounter(key){
      const current = parseInt(localStorage.getItem(key) || '0', 10) + 1;
      localStorage.setItem(key, String(current));
      return current;
    }
    function formatDoc(series, year, n){ return `${series}-${year}-${pad3(n)}`; }

    function setPill(code){
      const el = document.getElementById('pillNumber');
      if (el) el.textContent = `Nº: ${code}`;
    }

    function getBudgetNumberRaw(){
      const pill = document.getElementById('pillNumber')?.textContent || '';
      const m = pill.match(/([A-Z]+-\d{4}-\d{3})/);
      return m ? m[1] : null;
    }

    function newBudgetNumber(){
      const y = yearNow();
      const key = `counter_${BUDGET_SERIES}_${y}`;
      const n = nextCounter(key);
      const code = formatDoc(BUDGET_SERIES, y, n);
      setPill(code);
      return code;
    }

    // ==========================
    // PARTIDAS (demo funcional)
    // ==========================
    function addItemRow(data = {}){
      const items = document.getElementById('items');
      const row = document.createElement('div');
      row.className = 'item-row';
      row.innerHTML = `
        <div>
          <label>Descripción</label>
          <textarea class="item-desc" placeholder="Describe la partida...">${data.desc ?? ''}</textarea>
        </div>
        <div>
          <label>Cantidad</label>
          <input class="item-qty" type="number" min="0" step="0.01" value="${data.qty ?? ''}" />
        </div>
        <div>
          <label>Precio</label>
          <input class="item-price" type="number" min="0" step="0.01" value="${data.price ?? ''}" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn item-del" type="button">Eliminar</button>
        </div>
      `;
      row.querySelector('.item-del').addEventListener('click', () => row.remove());
      items.appendChild(row);
    }

    document.getElementById('btnAddItem').addEventListener('click', () => addItemRow());

    // ==========================
    // SNAPSHOT (guardar/cargar)
    // ==========================
    function snapshotBudget(){
      // 1) snapshot de todos los campos simples
      const fields = {};
      document.querySelectorAll('input, textarea, select').forEach(el => {
        if (!el.id) return;
        if (el.id === 'acceptText') return;
        fields[el.id] = el.value;
      });

      // 2) partidas (estructura estándar)
      const items = [];
      document.querySelectorAll('#items .item-row').forEach(r => {
        items.push({
          desc: r.querySelector('.item-desc')?.value ?? '',
          qty: r.querySelector('.item-qty')?.value ?? '',
          price: r.querySelector('.item-price')?.value ?? ''
        });
      });

      return { fields, items };
    }

    function restoreSnapshot(snap){
      if (!snap) return;

      // 1) campos
      if (snap.fields){
        Object.keys(snap.fields).forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = snap.fields[id];
        });
      }

      // 2) partidas
      const itemsWrap = document.getElementById('items');
      itemsWrap.innerHTML = '';
      (snap.items || []).forEach(it => addItemRow(it));
    }

    // ==========================
    // BLOQUEO (aceptado)
    // ==========================
    function keyAccepted(numberRaw){ return `accepted:${numberRaw}`; }
    function keySnapshot(numberRaw){ return `snapshot:${numberRaw}`; }
    function keyLastAccepted(){ return `lastAcceptedNumber`; }

    function isAcceptedLocked(numberRaw){
      return localStorage.getItem(keyAccepted(numberRaw)) === '1';
    }

    function lockUI(locked){
      const hint = document.getElementById('lockHint');
      if (locked){
        hint.textContent = 'Estado: Aceptado (bloqueado)';
      } else {
        hint.textContent = '';
      }
      document.querySelectorAll('input, textarea, select, #btnAddItem').forEach(el => {
        if (el.id === 'btnNewNumber') return;
        if (el.id === 'btnAccept') return;
        if (el.id === 'btnRevision') return;
        el.disabled = !!locked;
      });
      document.querySelectorAll('.item-del').forEach(b => b.disabled = !!locked);
    }

    // ==========================
    // MODAL (scroll + cierre)
    // ==========================
    const modal = document.getElementById('modal');
    const acceptText = document.getElementById('acceptText');

    function openModal(text){
      acceptText.textContent = text;
      modal.classList.add('open');
      document.body.classList.add('modal-open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modal.classList.remove('open');
      document.body.classList.remove('modal-open');
      modal.setAttribute('aria-hidden','true');
    }

    document.getElementById('btnCloseModal').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target?.getAttribute && e.target.getAttribute('data-close') === '1') closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // ==========================
    // TEXTO DE ACEPTACIÓN (tu plantilla)
    // ==========================
    function buildAcceptance(){
      const client = document.getElementById('clientName').value || '(Cliente)';
      const nif = document.getElementById('clientNif').value || '(DNI/NIF)';
      const addr = document.getElementById('workAddress').value || '(Dirección)';
      const contact = document.getElementById('clientContact').value || '(Contacto)';
      const terms = document.getElementById('terms').value || '(Condiciones)';
      const pro = document.getElementById('pro').value || '(Profesional)';
      const proContact = document.getElementById('proContact').value || '(Contacto profesional)';
      const numberRaw = getBudgetNumberRaw() || '(SIN NÚMERO)';

      const itemLines = [];
      document.querySelectorAll('#items .item-row').forEach((r, idx) => {
        const d = r.querySelector('.item-desc')?.value ?? '';
        const q = r.querySelector('.item-qty')?.value ?? '';
        const p = r.querySelector('.item-price')?.value ?? '';
        itemLines.push(`${idx+1}. ${d}\n   Cant.: ${q}  Precio: ${p}`);
      });

      return (
`PRESUPUESTO: ${numberRaw}

CLIENTE:
Nombre/Empresa: ${client}
DNI/NIF: ${nif}
Dirección: ${addr}
Contacto: ${contact}

PARTIDAS:
${itemLines.length ? itemLines.join('\n\n') : '(Sin partidas)'}

CONDICIONES DE PAGO Y PLAZOS:
${terms}

Confirmo la aceptación del presupuesto y autorizo el inicio de los trabajos según el alcance descrito.

Firma cliente: _____________________________   DNI/NIF: ____________________
Fecha: ____ / ____ / _______

Empresa / Profesional: ${pro}
Contacto: ${proContact}
`);
    }

    // ==========================
    // FLUJO: Generar número / Aceptar / Revisión
    // ==========================
    document.getElementById('btnNewNumber').addEventListener('click', () => {
      const code = newBudgetNumber();
      const locked = isAcceptedLocked(code);
      lockUI(locked);
      document.getElementById('btnRevision').disabled = !localStorage.getItem(keyLastAccepted());
    });

    document.getElementById('btnAccept').addEventListener('click', () => {
      // 1) abrir modal con texto completo
      openModal(buildAcceptance());

      // 2) marcar aceptado + guardar snapshot
      const numberRaw = getBudgetNumberRaw();
      if (!numberRaw){
        alert('Antes de aceptar, genera un número de presupuesto.');
        return;
      }
      const snap = snapshotBudget();
      localStorage.setItem(keySnapshot(numberRaw), JSON.stringify(snap));
      localStorage.setItem(keyAccepted(numberRaw), '1');
      localStorage.setItem(keyLastAccepted(), numberRaw);

      // 3) bloquear UI + habilitar revisión
      lockUI(true);
      document.getElementById('btnRevision').disabled = false;
    });

    document.getElementById('btnCopyAccept').addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(acceptText.textContent);
        alert('Texto copiado.');
      }catch(err){
        alert('No se pudo copiar automáticamente. Selecciona el texto y copia manualmente.');
      }
    });

    document.getElementById('btnRevision').addEventListener('click', () => {
      const lastAccepted = localStorage.getItem(keyLastAccepted());
      if (!lastAccepted){
        alert('No hay presupuesto aceptado para crear revisión.');
        return;
      }
      const snapStr = localStorage.getItem(keySnapshot(lastAccepted));
      if (!snapStr){
        alert('No se encontró el guardado del presupuesto aceptado.');
        return;
      }

      // Genera nuevo número y restaura snapshot
      const newCode = newBudgetNumber();
      const snap = JSON.parse(snapStr);
      restoreSnapshot(snap);

      // Asegura que el nuevo número quede puesto y NO esté marcado como aceptado
      setPill(newCode);
      localStorage.removeItem(keyAccepted(newCode));
      lockUI(false);

      alert(`Revisión creada: ${newCode}`);
    });

    // ==========================
    // ARRANQUE: crear 1 partida por defecto y estado UI
    // ==========================
    addItemRow();
    const existing = getBudgetNumberRaw();
    if (existing && isAcceptedLocked(existing)) lockUI(true);
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>




